<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>HIIT Timer</title>
    <style>
      html, body { height: 100%; }
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 16px;
        -webkit-text-size-adjust: 100%;
        touch-action: manipulation;
        box-sizing: border-box;
        background: #000;
        color: #fff;
      }
      *, *::before, *::after { box-sizing: inherit; }

      .listPanel {
        width: 100%;
        border: 1px solid #333;
        border-radius: 10px;
        padding: 12px;
        max-height: 240px;
        overflow: auto;
        background: #0b0b0b;
      }

      .listTitle {
        font-weight: 800;
        margin: 0 0 10px;
        font-size: 14px;
      }

      .list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .listItem {
        font-size: 14px;
        line-height: 1.2;
      }

      .listItem.current {
        font-weight: 800;
        text-decoration: underline;
      }

      .listItem.next {
        font-style: italic;
      }

      .video {
        border: 1px solid #333;
        border-radius: 10px;
        padding: 12px;
        width: 100%;
        background: #0b0b0b;
      }

      .videoTitle {
        font-weight: 800;
        margin: 0 0 10px;
        font-size: 14px;
      }

      .ytWrap {
        width: 100%;
        aspect-ratio: 16 / 9;
        border-radius: 10px;
        overflow: hidden;
        background: #000;
      }

      .ytWrap iframe {
        width: 100%;
        height: 100%;
        border: 0;
      }

      .container {
        min-height: calc(100vh - 32px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        gap: 12px;
        width: 100%;
        max-width: 720px;
        margin: 0 auto;
      }

      h1 { font-size: clamp(22px, 6vw, 34px); margin: 0; text-align: center; color: #fff; }
      .label { color: #ccc; font-size: clamp(16px, 4.5vw, 22px); margin: 0; text-align: center; }
      .time {
        font-size: clamp(96px, 18vw, 200px);
        font-weight: 800;
        letter-spacing: 1px;
        margin: 6px 0 6px;
        text-align: center;
        line-height: 1;
        color: #fff;
      }
      .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: stretch; justify-content: center; width: 100%; }
      button {
        padding: 18px 20px;
        font-size: clamp(18px, 5.5vw, 28px);
        font-weight: 700;
        cursor: pointer;
        border-radius: 10px;
        flex: 1 1 140px;
        background: #111;
        color: #fff;
        border: 1px solid #333;
      }
      .muted { color: #ccc; font-size: 13px; margin-top: 14px; line-height: 1.35; }
      .muted code { font-size: 0.95em; }
      /* Grey-out style similar to disabled equipment */
      .setDone .listPanel, .setDone .video, .setDone .row, .setDone .ytWrap { background: #1a1a1a; border-color: #333; }
      .setDone { opacity: 0.72; pointer-events: none; }

      @media (max-width: 420px) {
        .row { gap: 10px; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 id="title">HIIT</h1>
      <div class="label" id="subtitle">Chargement…</div>
      <div class="label" id="comingNext"></div>

      <div class="time" id="time">00:00</div>

      <section class="listPanel" id="listPanel" style="display:none;">
        <div class="listTitle">Liste • courant / next</div>
        <div class="list" id="exerciseList"></div>
      </section>

      <div class="row">
        <button id="start">Start</button>
        <button id="pause">Pause</button>
        <button id="reset">Reset</button>
      </div>

      <div class="row" id="hiitControls" style="display:none;">
        <button id="prev">Prev</button>
        <button id="toggleDone">Done</button>
        <button id="next">Next</button>
        <button id="doneSet">Done Set</button>
      </div>

      <section class="video" id="videoPanel" style="display:none;">
        <div class="videoTitle">Illustration</div>
        <div class="ytWrap">
          <img id="mediaImg" alt="Illustration" style="display:none; width:100%; height:100%; object-fit:contain;" />
        </div>
        <div class="muted" style="margin-top:10px;">
          <a id="mediaLink" href="#" target="_blank" rel="noopener noreferrer" style="display:none;">Ouvrir l'image</a>
        </div>
      </section>

      <div class="muted" id="tip">HIIT timer (40/20) • URL: <code>?page=timerhiit&userEmail=you%40mail.com&order=1&autostart=1</code></div>
    </div>

    <script>
      let autostart = false;
      let userEmail = '';
      let startOrderParam = NaN;

      function readParams_(cb) {
        const fromSearch = () => {
          const out = {};
          try {
            const qs = new URLSearchParams(window.location.search || '');
            for (const [k, v] of qs.entries()) out[k] = v;
          } catch (e) {}
          cb(out);
        };

        const canLoc = typeof google !== 'undefined' && google.script && google.script.url && typeof google.script.url.getLocation === 'function';
        if (!canLoc) return fromSearch();

        try {
          google.script.url.getLocation((loc) => {
            const p = (loc && loc.parameter) ? loc.parameter : null;
            if (p && Object.keys(p).length) return cb(p);
            // Fallback if Apps Script doesn't return params for some reason.
            return fromSearch();
          });
        } catch (e) {
          return fromSearch();
        }
      }

      const titleEl = document.getElementById('title');
      const subtitleEl = document.getElementById('subtitle');
      const comingNextEl = document.getElementById('comingNext');
      const timeEl = document.getElementById('time');
      const tipEl = document.getElementById('tip');
      const hiitControlsEl = document.getElementById('hiitControls');
      const toggleDoneBtn = document.getElementById('toggleDone');
      const listPanelEl = document.getElementById('listPanel');
      const exerciseListEl = document.getElementById('exerciseList');
      const videoPanelEl = document.getElementById('videoPanel');
      const mediaLinkEl = document.getElementById('mediaLink');
      const containerEl = document.querySelector('.container');

      // Optional: illustration image (gif/png/jpg/webp) instead of YouTube.
      // If you put a direct image URL into Glide_HIIT.Video_URL, it will show here.
      const mediaImgEl = document.getElementById('mediaImg');

      // Audio: triple beep. (Most mobile browsers require a user gesture to enable audio.)
      let audioCtx = null;
      function getAudioCtx() {
        if (audioCtx) return audioCtx;
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) return null;
        audioCtx = new Ctx();
        return audioCtx;
      }

      async function primeAudio() {
        try {
          const ctx = getAudioCtx();
          if (!ctx) return;
          if (ctx.state === 'suspended') await ctx.resume();
        } catch (e) {}
      }

      function scheduleBeep_(ctx, startInMs, durationMs, freqHz) {
        try {
          const t0 = ctx.currentTime + (startInMs / 1000);
          const t1 = t0 + (durationMs / 1000);
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = 'sine';
          osc.frequency.value = freqHz;
          gain.gain.setValueAtTime(0.0001, t0);
          gain.gain.exponentialRampToValueAtTime(0.20, t0 + 0.01);
          gain.gain.exponentialRampToValueAtTime(0.0001, t1);
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.start(t0);
          osc.stop(t1);
        } catch (e) {}
      }

      function makeWavBeepDataUri_(freqHz, durationMs) {
        // Generate a tiny PCM WAV beep (original content) to avoid external assets.
        const sampleRate = 44100;
        const seconds = Math.max(0.02, (Number(durationMs) || 120) / 1000);
        const totalSamples = Math.floor(sampleRate * seconds);
        const numChannels = 1;
        const bitsPerSample = 16;
        const blockAlign = numChannels * bitsPerSample / 8;
        const byteRate = sampleRate * blockAlign;
        const dataSize = totalSamples * blockAlign;

        const buffer = new ArrayBuffer(44 + dataSize);
        const view = new DataView(buffer);
        let p = 0;
        const writeStr = (s) => { for (let i = 0; i < s.length; i++) view.setUint8(p++, s.charCodeAt(i)); };
        const writeU32 = (v) => { view.setUint32(p, v, true); p += 4; };
        const writeU16 = (v) => { view.setUint16(p, v, true); p += 2; };

        writeStr('RIFF');
        writeU32(36 + dataSize);
        writeStr('WAVE');
        writeStr('fmt ');
        writeU32(16);
        writeU16(1);
        writeU16(numChannels);
        writeU32(sampleRate);
        writeU32(byteRate);
        writeU16(blockAlign);
        writeU16(bitsPerSample);
        writeStr('data');
        writeU32(dataSize);

        const freq = Number(freqHz) || 880;
        const amp = 0.35;
        for (let i = 0; i < totalSamples; i++) {
          // Simple sine + fade in/out to reduce clicks.
          const t = i / sampleRate;
          const fadeIn = Math.min(1, i / (sampleRate * 0.01));
          const fadeOut = Math.min(1, (totalSamples - 1 - i) / (sampleRate * 0.02));
          const env = Math.max(0, Math.min(1, fadeIn, fadeOut));
          const s = Math.sin(2 * Math.PI * freq * t) * amp * env;
          view.setInt16(p, Math.max(-1, Math.min(1, s)) * 32767, true);
          p += 2;
        }

        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
        return 'data:audio/wav;base64,' + btoa(binary);
      }

      let beepAudioEl_ = null;
      function getBeepAudioEl_() {
        if (beepAudioEl_) return beepAudioEl_;
        beepAudioEl_ = new Audio(makeWavBeepDataUri_(880, 120));
        beepAudioEl_.preload = 'auto';
        return beepAudioEl_;
      }

      function playFallbackBeep_() {
        try {
          const el = getBeepAudioEl_();
          el.currentTime = 0;
          const p = el.play();
          if (p && typeof p.catch === 'function') p.catch(() => {});
        } catch (e) {}
      }

      function tripleBeep() {
        const ctx = getAudioCtx();
        const doBeeps = () => {
          if (ctx && ctx.state === 'running') {
            scheduleBeep_(ctx, 0, 120, 880);
            scheduleBeep_(ctx, 200, 120, 880);
            scheduleBeep_(ctx, 400, 120, 880);
          } else {
            playFallbackBeep_();
            setTimeout(playFallbackBeep_, 200);
            setTimeout(playFallbackBeep_, 400);
          }
          try { navigator.vibrate && navigator.vibrate([120, 80, 120, 80, 120]); } catch (e) {}
        };

        if (!ctx) return doBeeps();
        if (ctx.state === 'suspended') {
          ctx.resume().then(doBeeps).catch(doBeeps);
          return;
        }
        doBeeps();
      }

      function fmt(s) {
        const ss = Math.max(0, Math.floor(s));
        const m = Math.floor(ss / 60);
        const r = ss % 60;
        return `${String(m).padStart(2, '0')}:${String(r).padStart(2, '0')}`;
      }

      let timer = null;
      let hiit = {
        items: [],
        idx: 0,
        phase: 'work',
        phaseRemaining: 0,
        running: false,
        endAt: 0
      };

      function currentHiitItem() {
        return hiit.items && hiit.items.length > 0 ? hiit.items[hiit.idx] : null;
      }

      function getRememberedEmail_() {
        try {
          const v = String(window.localStorage ? (localStorage.getItem('hiitUserEmail') || '') : '').trim();
          return v;
        } catch (e) {
          return '';
        }
      }

      function rememberEmail_(email) {
        try {
          if (!window.localStorage) return;
          const v = String(email || '').trim();
          if (!v) return;
          localStorage.setItem('hiitUserEmail', v);
        } catch (e) {}
      }

      function renderMissingEmail_() {
        titleEl.textContent = 'HIIT';
        subtitleEl.textContent = 'Missing user email';
        comingNextEl.textContent = '';
        timeEl.textContent = '00:00';
        hiitControlsEl.style.display = 'none';
        listPanelEl.style.display = 'none';
        videoPanelEl.style.display = 'none';
        tipEl.innerHTML = 'Open with: <code>?page=timerhiit&userEmail=you%40mail.com&order=1&autostart=1</code>';
      }

      function nextHiitItem() {
        return hiit.items && hiit.items.length > 0 && (hiit.idx + 1) < hiit.items.length ? hiit.items[hiit.idx + 1] : null;
      }

      function isImageUrl_(url) {
        const u = String(url || '').trim().toLowerCase();
        return u.endsWith('.gif') || u.endsWith('.png') || u.endsWith('.jpg') || u.endsWith('.jpeg') || u.endsWith('.webp');
      }
      function isYouTubeUrl_(url) {
        const u = String(url || '').trim().toLowerCase();
        return !!u && (u.includes('youtube.com') || u.includes('youtu.be'));
      }
      function updateVideo_() {
        const item = currentHiitItem();
        const q = item && item.exercise ? String(item.exercise) : '';
        if (!q) {
          videoPanelEl.style.display = 'none';
          if (mediaImgEl) {
            mediaImgEl.style.display = 'none';
            mediaImgEl.src = '';
          }
          if (mediaLinkEl) {
            mediaLinkEl.style.display = 'none';
            mediaLinkEl.href = '#';
          }
          return;
        }

        // Only show media when a direct image URL is provided.
        const rawUrl = item && item.videoUrl ? String(item.videoUrl).trim() : '';
        if (!rawUrl || !isImageUrl_(rawUrl)) {
          videoPanelEl.style.display = 'none';
          if (mediaImgEl) {
            mediaImgEl.style.display = 'none';
            mediaImgEl.src = '';
          }
          if (mediaLinkEl) {
            mediaLinkEl.style.display = 'none';
            mediaLinkEl.href = '#';
          }
          return;
        }

        videoPanelEl.style.display = '';
        if (mediaImgEl) {
          mediaImgEl.style.display = '';
          mediaImgEl.src = rawUrl;
        }
        if (mediaLinkEl) {
          mediaLinkEl.style.display = '';
          mediaLinkEl.href = rawUrl;
        }
      }

      function renderList_() {
        const items = hiit.items || [];
        if (!items.length) {
          exerciseListEl.textContent = '';
          listPanelEl.style.display = 'none';
          return;
        }

        listPanelEl.style.display = '';

        exerciseListEl.textContent = '';
        for (let i = 0; i < items.length; i++) {
          const it = items[i];
          const div = document.createElement('div');
          div.className = 'listItem' + (i === hiit.idx ? ' current' : '') + (i === hiit.idx + 1 ? ' next' : '');
          const doneMark = it && it.isDone ? '✓ ' : '';
          const nameText = `${doneMark}${i + 1}. ${it && it.exercise ? it.exercise : ''}`;
          const nameSpan = document.createElement('span');
          nameSpan.textContent = nameText;
          div.appendChild(nameSpan);
          const rawUrl = it && it.videoUrl ? String(it.videoUrl).trim() : '';
          if (rawUrl) {
            const a = document.createElement('a');
            a.href = rawUrl;
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            a.textContent = ' ↗';
            a.style.marginLeft = '6px';
            a.style.fontSize = '12px';
            a.style.opacity = '0.85';
            div.appendChild(a);
          }
          // Allow clicking list items to jump to that exercise.
          div.style.cursor = 'pointer';
          div.addEventListener('click', () => {
            const wasRunning = !!hiit.running;
            stop();
            hiit.running = wasRunning;
            jumpToHiitIndex(i);
            if (wasRunning) startHiit();
          });
          exerciseListEl.appendChild(div);
        }
      }
      function markAllDone_() {
        if (!userEmail) return;
        const canRun = typeof google !== 'undefined' && google.script && google.script.run;
        if (!canRun) return;
        const items = (hiit.items || []).slice();
        if (!items.length) return;
        let pending = 0;
        const finalize = () => {
          try { containerEl && containerEl.classList.add('setDone'); } catch (e) {}
          renderList_();
          setDoneButtonLabel();
        };
        items.forEach((it) => {
          if (!it || !Number.isFinite(it.order)) return;
          pending++;
          google.script.run
            .withSuccessHandler((res) => {
              if (res && res.status === 'ok') it.isDone = true;
              if (--pending === 0) finalize();
            })
            .withFailureHandler(() => {
              if (--pending === 0) finalize();
            })
            .setHiitIsDone(userEmail, it.order, true);
        });
        if (pending === 0) finalize();
      }

      function markCurrentDone_(desired) {
        const item = currentHiitItem();
        if (!item) return;
        const want = !!desired;
        if (!!item.isDone === want) return;
        if (!userEmail) return;
        const canRun = typeof google !== 'undefined' && google.script && google.script.run;
        if (!canRun) return;

        google.script.run
          .withSuccessHandler((res) => {
            if (res && res.status === 'ok') {
              item.isDone = !!res.isDone;
              setDoneButtonLabel();
              renderList_();
            }
          })
          .withFailureHandler(() => {})
          .setHiitIsDone(userEmail, item.order, want);
      }

      function setDoneButtonLabel() {
        const item = currentHiitItem();
        if (!item) {
          toggleDoneBtn.textContent = 'Done';
          toggleDoneBtn.disabled = true;
          return;
        }
        toggleDoneBtn.disabled = false;
        toggleDoneBtn.textContent = item.isDone ? 'Undo' : 'Done';
      }

      function renderHiit() {
        const item = currentHiitItem();
        const total = hiit.items.length;
        const n = hiit.idx + 1;
        const phaseLabel = hiit.phase === 'work' ? 'WORK' : 'REST';

        titleEl.textContent = item && item.exercise ? item.exercise : 'HIIT';
        const intervalLabel = item && item.intervalLabel
          ? item.intervalLabel
          : `${item && item.work_s ? item.work_s : 40}/${item && item.rest_s ? item.rest_s : 20}`;
        subtitleEl.textContent = `${phaseLabel} • ${intervalLabel} • ${n}/${total}`;
        timeEl.textContent = fmt(hiit.phaseRemaining);
        setDoneButtonLabel();

        const next = nextHiitItem();
        comingNextEl.textContent = next && next.exercise ? `Coming next: ${next.exercise}` : '';

        renderList_();
      }

      function stop() {
        if (timer) {
          clearInterval(timer);
          timer = null;
        }
      }

      function stopHiit() {
        // Pause: capture remaining before stopping so resume is accurate.
        if (timer) {
          const diff = Math.round((hiit.endAt - Date.now()) / 1000);
          hiit.phaseRemaining = Math.max(0, diff);
        }
        hiit.running = false;
        stop();
        renderHiit();
      }

      function nextHiitPhaseOrExercise() {
        const item = currentHiitItem();
        if (!item) {
          stopHiit();
          titleEl.textContent = 'HIIT';
          subtitleEl.textContent = 'Aucun exercice';
          comingNextEl.textContent = '';
          timeEl.textContent = '00:00';
          return;
        }

        if (hiit.phase === 'work') {
          // Auto-mark done when a WORK interval finishes.
          markCurrentDone_(true);
          // Always transition to REST, even for the last exercise.
          hiit.phase = 'rest';
          hiit.phaseRemaining = Number.isFinite(item.rest_s) && item.rest_s > 0 ? item.rest_s : 20;
          hiit.endAt = Date.now() + hiit.phaseRemaining * 1000;
          renderHiit();
          return;
        }

        // REST finished: if we were on the last exercise, end the workout. Otherwise advance.
        const wasLast = hiit.idx >= hiit.items.length - 1;
        if (wasLast) {
          stopHiit();
          titleEl.textContent = 'Terminé';
          subtitleEl.textContent = `${hiit.items.length}/${hiit.items.length}`;
          comingNextEl.textContent = '';
          timeEl.textContent = '00:00';
          tripleBeep();
          return;
        }

        hiit.idx = Math.min(hiit.idx + 1, hiit.items.length - 1);
        hiit.phase = 'work';
        const next = currentHiitItem();
        hiit.phaseRemaining = Number.isFinite(next.work_s) && next.work_s > 0 ? next.work_s : 40;
        hiit.endAt = Date.now() + hiit.phaseRemaining * 1000;
        updateVideo_();
        renderHiit();
        // Ensure we continue running after transitions.
        hiit.running = true;
      }

      function startHiit() {
        // Start should be idempotent: if a background/autostart interval exists (or got throttled), restart cleanly.
        if (timer) {
          clearInterval(timer);
          timer = null;
        }
        if (!hiit.items || hiit.items.length === 0) return;
        hiit.running = true;

        if (!hiit.phaseRemaining || hiit.phaseRemaining <= 0) {
          const item = currentHiitItem();
          hiit.phase = 'work';
          hiit.phaseRemaining = Number.isFinite(item.work_s) && item.work_s > 0 ? item.work_s : 40;
          renderHiit();
        }

        // Always recompute endAt from the *current* remaining time (proper resume).
        hiit.endAt = Date.now() + hiit.phaseRemaining * 1000;

        timer = setInterval(() => {
          const diff = Math.round((hiit.endAt - Date.now()) / 1000);
          hiit.phaseRemaining = Math.max(0, diff);
          renderHiit();
          if (hiit.phaseRemaining <= 0) {
            tripleBeep();
            nextHiitPhaseOrExercise();
            if (!hiit.running) stop();
          }
        }, 100);
      }

      function jumpToHiitIndex(newIdx) {
        if (!hiit.items || hiit.items.length === 0) return;
        const idx = Math.max(0, Math.min(newIdx, hiit.items.length - 1));
        hiit.idx = idx;
        hiit.phase = 'work';
        const item = currentHiitItem();
        hiit.phaseRemaining = item ? (Number.isFinite(item.work_s) && item.work_s > 0 ? item.work_s : 40) : 0;
        hiit.endAt = Date.now() + hiit.phaseRemaining * 1000;
        updateVideo_();
        renderHiit();
        if (hiit.running && !timer) startHiit();
      }

      function toggleHiitDone() {
        const item = currentHiitItem();
        if (!item) return;
        if (!userEmail) return;
        const canRun = typeof google !== 'undefined' && google.script && google.script.run;
        if (!canRun) return;
        const newVal = !item.isDone;
        toggleDoneBtn.disabled = true;
        google.script.run
          .withSuccessHandler((res) => {
            if (res && res.status === 'ok') {
              item.isDone = !!res.isDone;
              setDoneButtonLabel();
            }
            toggleDoneBtn.disabled = false;
          })
          .withFailureHandler(() => {
            toggleDoneBtn.disabled = false;
          })
          .setHiitIsDone(userEmail, item.order, newVal);
      }

      document.getElementById('start').addEventListener('click', () => {
        // Start immediately; prime audio asynchronously so UI isn't blocked by audio permission checks
        startHiit();
        primeAudio();
      });
      document.getElementById('pause').addEventListener('click', stopHiit);
      document.getElementById('reset').addEventListener('click', () => {
        stop();
        hiit.running = false;
        hiit.phase = 'work';
        const item = currentHiitItem();
        hiit.phaseRemaining = item ? (Number.isFinite(item.work_s) && item.work_s > 0 ? item.work_s : 40) : 0;
        hiit.endAt = Date.now() + hiit.phaseRemaining * 1000;
        renderHiit();
      });

      document.getElementById('prev').addEventListener('click', () => {
        stop();
        hiit.running = false;
        jumpToHiitIndex(hiit.idx - 1);
      });

      document.getElementById('next').addEventListener('click', () => {
        stop();
        hiit.running = false;
        jumpToHiitIndex(hiit.idx + 1);
      });

      toggleDoneBtn.addEventListener('click', toggleHiitDone);
      document.getElementById('doneSet').addEventListener('click', markAllDone_);

      // Load HIIT list
      (function init() {
        const canRun = typeof google !== 'undefined' && google.script && google.script.run;
        if (!canRun) {
          titleEl.textContent = 'HIIT';
          subtitleEl.textContent = 'Erreur: google.script.run indisponible (Web App Apps Script requis)';
          comingNextEl.textContent = '';
          timeEl.textContent = '00:00';
          return;
        }

        titleEl.textContent = 'HIIT';
        subtitleEl.textContent = 'Chargement…';
        timeEl.textContent = '00:00';

        readParams_((params) => {
          autostart = String(params.autostart || '').trim() === '1';
          userEmail = String(params.userEmail || params.email || '').trim();
          startOrderParam = parseInt(String(params.order || '').trim(), 10);

          // Prefer explicit query param, then remembered email.
          if (!userEmail) {
            const remembered = getRememberedEmail_();
            if (remembered) userEmail = remembered;
          }

          const loadWithEmail_ = (email) => {
            const em = String(email || '').trim();
            if (!em) return renderMissingEmail_();
            userEmail = em;
            rememberEmail_(userEmail);

            google.script.run
              .withSuccessHandler((res) => {
                if (!res || res.status !== 'ok') {
                  titleEl.textContent = 'HIIT';
                  subtitleEl.textContent = (res && res.msg) ? res.msg : 'Erreur chargement';
                  comingNextEl.textContent = '';
                  timeEl.textContent = '00:00';
                  return;
                }

                // Server may return the resolved email it used; keep it.
                if (res.userEmail) {
                  userEmail = String(res.userEmail).trim();
                  rememberEmail_(userEmail);
                }

                if (!res.items || res.items.length === 0) {
                  titleEl.textContent = 'HIIT';
                  subtitleEl.textContent = 'Aucun exercice HIIT (génère la séance d\'abord)';
                  comingNextEl.textContent = '';
                  timeEl.textContent = '00:00';
                  return;
                }

                hiitControlsEl.style.display = '';
                hiit.items = (res.items || []).filter(it => it && it.exercise);

                if (Number.isFinite(startOrderParam) && startOrderParam > 0) {
                  const idx = hiit.items.findIndex(it => Number(it.order) === startOrderParam);
                  hiit.idx = idx !== -1 ? idx : 0;
                } else {
                  hiit.idx = 0;
                }

                hiit.phase = 'work';
                const first = currentHiitItem();
                hiit.phaseRemaining = first ? (Number.isFinite(first.work_s) && first.work_s > 0 ? first.work_s : 40) : 0;
                hiit.endAt = Date.now() + hiit.phaseRemaining * 1000;
                try {
                  updateVideo_();
                } catch (e) {
                  // Avoid blocking the timer UI if illustration rendering fails.
                }
                renderHiit();
                if (autostart) startHiit();
              })
              .withFailureHandler((err) => {
                titleEl.textContent = 'HIIT';
                subtitleEl.textContent = (err && err.message) ? ('Erreur Apps Script: ' + err.message) : 'Erreur Apps Script';
                timeEl.textContent = '00:00';
              })
              .getHiitTimerData(userEmail);
          };

          if (userEmail) {
            loadWithEmail_(userEmail);
          } else {
            // Fallback: try reading Apps Script active user (may be blank for consumer accounts).
            google.script.run
              .withSuccessHandler((res) => {
                const em = res && res.email ? String(res.email).trim() : '';
                if (!em) return renderMissingEmail_();
                loadWithEmail_(em);
              })
              .withFailureHandler(() => {
                renderMissingEmail_();
              })
              .getUserEmail();
          }

          tipEl.innerHTML = 'HIIT timer • URL: <code>?page=timerhiit&userEmail=you%40mail.com&order=1&autostart=1</code>';
        });
      })();
    </script>
  </body>
</html>
